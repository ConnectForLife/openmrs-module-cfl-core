<?xml version="1.0" encoding="UTF-8"?>
 
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
 
    <!--
    	See http://wiki.openmrs.org/display/docs/Module+liquibase+File for
    	documentation on this file.

        See http://www.liquibase.org/manual/home#available_database_refactorings
        for a list of supported elements and attributes
    -->
    
    <changeSet id="cfl-20190808-11:50" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM person_attribute_type WHERE uuid = "bfdf8ed0-87e3-437e-897d-81434393a233";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the Location personAttribute.
        </comment>
        <insert tableName="person_attribute_type">
            <column name="name">LocationAttribute</column>
            <column name="description">Attribute used to store information about patient localization</column>
            <column name="format">java.lang.String</column>
            <column name="searchable">0</column>
            <column name="uuid">bfdf8ed0-87e3-437e-897d-81434393a233</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190808-11:51" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM person_attribute_type WHERE uuid = "ff34db58-c1f4-475b-8bac-30f26e251333";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the Language personAttribute.
        </comment>
        <insert tableName="person_attribute_type">
            <column name="name">personLanguage</column>
            <column name="description">Attribute used to store information about patient language</column>
            <column name="format">java.lang.String</column>
            <column name="searchable">0</column>
            <column name="uuid">ff34db58-c1f4-475b-8bac-30f26e251333</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190808-11:52" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM person_attribute_type WHERE uuid = "a5476c49-32d2-489e-a90b-d08be4b5cff9";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the DND consent personAttribute.
        </comment>
        <insert tableName="person_attribute_type">
            <column name="name">dndConsent</column>
            <column name="description">Attribute used to store information about patient dnd consent</column>
            <column name="format">java.lang.String</column>
            <column name="searchable">0</column>
            <column name="uuid">a5476c49-32d2-489e-a90b-d08be4b5cff9</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190808-11:53" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patient_identifier_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM patient_identifier_type WHERE uuid ="4aa897a3-0b05-4ec9-8d70-a93a336be548";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the Aadhar Number patientIdentifierType.
        </comment>
        <insert tableName="patient_identifier_type">
            <column name="name">Aadhar Number</column>
            <column name="description">CFL Aadhar Number</column>
            <column name="check_digit">0</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
            <column name="required">0</column>
            <column name="location_behavior">NOT_USED</column>
            <column name="uuid">4aa897a3-0b05-4ec9-8d70-a93a336be548</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190808-11:54" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patient_identifier_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM patient_identifier_type WHERE uuid ="2a4c3f45-405b-41ab-b6cd-f3c5ad2f5007";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the Aadhar Number patientIdentifierType.
        </comment>
        <insert tableName="patient_identifier_type">
            <column name="name">ART Number</column>
            <column name="description">CFL ART Number</column>
            <column name="check_digit">0</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
            <column name="required">0</column>
            <column name="location_behavior">NOT_USED</column>
            <column name="uuid">2a4c3f45-405b-41ab-b6cd-f3c5ad2f5007</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190809-09:01" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="concept" />
            <sqlCheck expectedResult="0">
                select count(*) from concept where uuid='f7c6f4f7-89d2-48f9-8844-c1a6564231c0'
            </sqlCheck>
        </preConditions>
        <comment>
            Added new concepts, which represents a new question and answers used by the CFL forms.
        </comment>
        <sql>
            -- Risk factor for HIV - Question
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d491e50-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Risk factor for HIV', 'en-GB', '1', '2019-08-08', '0', '1', 'e3ee53be-8015-452c-99fa-37c3757054bd'
            FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0';

            -- Heterosexual - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '7b52533b-c396-474b-b9df-b8c156f66b5d', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Heterosexual', 'en-GB', '1', '2019-08-08', '0', '1', '3e400be9-c115-456c-b7ea-7d83f6f8a882'
            FROM concept WHERE uuid = '7b52533b-c396-474b-b9df-b8c156f66b5d';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '7b52533b-c396-474b-b9df-b8c156f66b5d'),
            '1', '2019-08-08', UUID());

            -- Blood transfusion - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '57624032-3bc9-46a7-b0e6-bb7930d80277', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Blood transfusion', 'en-GB', '1', '2019-08-08', '0', '1', 'e231b64b-66cf-46e0-b49b-d0ca33daaa61'
            FROM concept WHERE uuid = '57624032-3bc9-46a7-b0e6-bb7930d80277';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '57624032-3bc9-46a7-b0e6-bb7930d80277'),
            '1', '2019-08-08', UUID());

            -- Trucker - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'fb2045ef-7b1a-4e90-9f47-408aca35c2a8', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Trucker', 'en-GB', '1', '2019-08-08', '0', '1', '699a6db1-95b4-4da4-bf8e-8c490bbf1a68'
            FROM concept WHERE uuid = 'fb2045ef-7b1a-4e90-9f47-408aca35c2a8';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = 'fb2045ef-7b1a-4e90-9f47-408aca35c2a8'),
            '1', '2019-08-08', UUID());

            -- MSM - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '1db7ff2a-5f20-4bdc-890b-3a348e06edc6', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'MSM', 'en-GB', '1', '2019-08-08', '0', '1', '3308a83e-f273-4cff-b77b-fc8690500ffa'
            FROM concept WHERE uuid = '1db7ff2a-5f20-4bdc-890b-3a348e06edc6';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '1db7ff2a-5f20-4bdc-890b-3a348e06edc6'),
            '1', '2019-08-08', UUID());

            -- Mother to child - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '4c5d3452-19b4-4703-88c2-f3d061019527', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Mother to child', 'en-GB', '1', '2019-08-08', '0', '1', '4663bb25-989e-4700-8414-89e8279fc7e8'
            FROM concept WHERE uuid = '4c5d3452-19b4-4703-88c2-f3d061019527';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '4c5d3452-19b4-4703-88c2-f3d061019527'),
            '1', '2019-08-08', UUID());

            -- Commercial sex work - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '154c910f-a66b-4517-a541-130931274ca7', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Commercial sex work', 'en-GB', '1', '2019-08-08', '0', '1', 'b01c15d4-f878-4c7f-9149-02e477e1c874'
            FROM concept WHERE uuid = '154c910f-a66b-4517-a541-130931274ca7';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '154c910f-a66b-4517-a541-130931274ca7'),
            '1', '2019-08-08', UUID());

            -- Injecting drug use (IDU) - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '8c4e1b8a-cc7a-4028-8077-ece704c782f7', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Injecting drug use (IDU)', 'en-GB', '1', '2019-08-08', '0', '1', '333ff6d3-866a-41bf-b967-7cb18a330024'
            FROM concept WHERE uuid = '8c4e1b8a-cc7a-4028-8077-ece704c782f7';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '8c4e1b8a-cc7a-4028-8077-ece704c782f7'),
            '1', '2019-08-08', UUID());

            -- Probable unsafe injection - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '553b9a1d-d117-4460-9c8c-2c0eb5ad0518', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Probable unsafe injection', 'en-GB', '1', '2019-08-08', '0', '1', '885adf20-6abc-4a43-ab60-ff45c647f6d4'
            FROM concept WHERE uuid = '553b9a1d-d117-4460-9c8c-2c0eb5ad0518';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '553b9a1d-d117-4460-9c8c-2c0eb5ad0518'),
            '1', '2019-08-08', UUID());

            -- Migrant - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '24750e2b-d4b6-437f-a092-d99a319dddab', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Migrant', 'en-GB', '1', '2019-08-08', '0', '1', 'c805bd15-c51f-413b-8cb4-239b8b760e92'
            FROM concept WHERE uuid = '24750e2b-d4b6-437f-a092-d99a319dddab';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '24750e2b-d4b6-437f-a092-d99a319dddab'),
            '1', '2019-08-08', UUID());

            -- Unknown - Answer
            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'f7c6f4f7-89d2-48f9-8844-c1a6564231c0'),
            (SELECT concept_id FROM concept WHERE uuid = '1067AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'),
            '1', '2019-08-08', UUID());

            -- High Risk Groups - Question
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '9994a4aa-981b-4605-8f4f-23e02e64106e', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d491e50-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'High Risk Groups', 'en-GB', '1', '2019-08-08', '0', '1', '4c26edef-4eb9-4069-b1b6-d81c50866272'
            FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e';

            -- 2nd Line - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'ea15773b-714a-492c-b7f0-c13b9e8b7166', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, '2nd Line', 'en-GB', '1', '2019-08-08', '0', '1', '421eb3f5-e064-4c46-83ad-6d30ec8e3a2b'
            FROM concept WHERE uuid = 'ea15773b-714a-492c-b7f0-c13b9e8b7166';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e'),
            (SELECT concept_id FROM concept WHERE uuid = 'ea15773b-714a-492c-b7f0-c13b9e8b7166'),
            '1', '2019-08-08', UUID());

            -- Patient with family issues - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '52bc8545-88d6-4f12-a6f9-386496b22b76', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Patient with family issues', 'en-GB', '1', '2019-08-08', '0', '1', 'f7b58089-d280-4599-9afc-fbd345f8aea3'
            FROM concept WHERE uuid = '52bc8545-88d6-4f12-a6f9-386496b22b76';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e'),
            (SELECT concept_id FROM concept WHERE uuid = '52bc8545-88d6-4f12-a6f9-386496b22b76'),
            '1', '2019-08-08', UUID());

            -- Co infected patients (others than TB) - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '4185ab0d-069d-440f-a4f3-aef07f0f6231', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Co infected patients (others than TB)', 'en-GB', '1', '2019-08-08', '0', '1', 'ae24294d-f35a-4ba2-a8b9-afe0c8ba746a'
            FROM concept WHERE uuid = '4185ab0d-069d-440f-a4f3-aef07f0f6231';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e'),
            (SELECT concept_id FROM concept WHERE uuid = '4185ab0d-069d-440f-a4f3-aef07f0f6231'),
            '1', '2019-08-08', UUID());

            -- Patient on alternate treatment - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'b0095cdf-8dd6-46f8-8b30-19c451e3b8d5', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Patient on alternate treatment', 'en-GB', '1', '2019-08-08', '0', '1', '07ece597-5af0-448a-887f-179b71afcf83'
            FROM concept WHERE uuid = 'b0095cdf-8dd6-46f8-8b30-19c451e3b8d5';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e'),
            (SELECT concept_id FROM concept WHERE uuid = 'b0095cdf-8dd6-46f8-8b30-19c451e3b8d5'),
            '1', '2019-08-08', UUID());

            -- LFU and regular defaulters - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '9027f618-09b5-41cd-9330-b549d0dd280d', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'LFU and regular defaulters', 'en-GB', '1', '2019-08-08', '0', '1', 'd3906689-0cdc-481d-ab10-0b6f0734846b'
            FROM concept WHERE uuid = '9027f618-09b5-41cd-9330-b549d0dd280d';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e'),
            (SELECT concept_id FROM concept WHERE uuid = '9027f618-09b5-41cd-9330-b549d0dd280d'),
            '1', '2019-08-08', UUID());

            -- Other - answer

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '9994a4aa-981b-4605-8f4f-23e02e64106e'),
            (SELECT concept_id FROM concept WHERE uuid = '5622AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'),
            '1', '2019-08-08', UUID());

            -- TB - Question
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '01f37a87-14a3-496d-88fe-00d3d1fea03c', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d491e50-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'TB', 'en-GB', '1', '2019-08-08', '0', '1', 'd816bb11-6f88-457a-a6fa-c9522586a605'
            FROM concept WHERE uuid = '01f37a87-14a3-496d-88fe-00d3d1fea03c';

            -- Patient with previous history of TB - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '3d0460b8-40c7-47df-b5c3-f8d7d31c533f', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Patient with previous history of TB', 'en-GB', '1', '2019-08-08', '0', '1', '7b7ebc1c-156f-4b77-8b4f-cacdc41fdfd6'
            FROM concept WHERE uuid = '3d0460b8-40c7-47df-b5c3-f8d7d31c533f';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '01f37a87-14a3-496d-88fe-00d3d1fea03c'),
            (SELECT concept_id FROM concept WHERE uuid = '3d0460b8-40c7-47df-b5c3-f8d7d31c533f'),
            '1', '2019-08-08', UUID());

            -- Patient with current diagnosis of TB - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '4503b322-d946-4d0a-8878-eb0650d3976b', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Patient with current diagnosis of TB', 'en-GB', '1', '2019-08-08', '0', '1', '879d5abf-c694-4605-a637-6da6c6939379'
            FROM concept WHERE uuid = '4503b322-d946-4d0a-8878-eb0650d3976b';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = '01f37a87-14a3-496d-88fe-00d3d1fea03c'),
            (SELECT concept_id FROM concept WHERE uuid = '4503b322-d946-4d0a-8878-eb0650d3976b'),
            '1', '2019-08-08', UUID());

            -- Treatment Status - Question
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'c59d7c13-7037-4a70-9f14-ec8b727d1c12', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d491e50-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Treatment Status', 'en-GB', '1', '2019-08-08', '0', '1', 'fe38292f-ea78-4c7a-9729-f347067cf98f'
            FROM concept WHERE uuid = 'c59d7c13-7037-4a70-9f14-ec8b727d1c12';

            -- Under Treatment - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'f6c9f4e0-143f-4cb2-9346-35c266f5f803', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Under Treatment', 'en-GB', '1', '2019-08-08', '0', '1', '5305c075-3adf-43d4-8665-02e67c01649f'
            FROM concept WHERE uuid = 'f6c9f4e0-143f-4cb2-9346-35c266f5f803';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'c59d7c13-7037-4a70-9f14-ec8b727d1c12'),
            (SELECT concept_id FROM concept WHERE uuid = 'f6c9f4e0-143f-4cb2-9346-35c266f5f803'),
            '1', '2019-08-08', UUID());

            -- Treatment completed - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT 'b4f0332a-ea36-4086-a4e9-e1136c541487', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Treatment completed', 'en-GB', '1', '2019-08-08', '0', '1', '22bf92a7-bf0f-4358-a509-4dbf25281dfd'
            FROM concept WHERE uuid = 'b4f0332a-ea36-4086-a4e9-e1136c541487';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'c59d7c13-7037-4a70-9f14-ec8b727d1c12'),
            (SELECT concept_id FROM concept WHERE uuid = 'b4f0332a-ea36-4086-a4e9-e1136c541487'),
            '1', '2019-08-08', UUID());

            -- Treatment failure/transfer out - Diagnosis
            INSERT INTO concept (uuid, retired, datatype_id, class_id, creator, date_created)
            SELECT '15bd5100-cd85-4bbd-a848-8d3a19b1e738', '0', c_datatype.concept_datatype_id, c_class.concept_class_id, '1', '2019-08-08'
            FROM concept_datatype c_datatype INNER JOIN  concept_class c_class
            WHERE c_datatype.hl7_abbreviation = 'CWE' AND c_class.uuid = '8d4918b0-c2cc-11de-8d13-0010c6dffd0f';

            INSERT INTO concept_name (concept_id, name, locale, creator, date_created, voided, locale_preferred, uuid)
            SELECT concept_id, 'Treatment failure/transfer out', 'en-GB', '1', '2019-08-08', '0', '1', '62a7cecf-e2c1-46f4-82d1-655c286b0e71'
            FROM concept WHERE uuid = '15bd5100-cd85-4bbd-a848-8d3a19b1e738';

            INSERT INTO concept_answer (concept_id, answer_concept, creator, date_created, uuid) VALUES
            ((SELECT concept_id FROM concept WHERE uuid = 'c59d7c13-7037-4a70-9f14-ec8b727d1c12'),
            (SELECT concept_id FROM concept WHERE uuid = '15bd5100-cd85-4bbd-a848-8d3a19b1e738'),
            '1', '2019-08-08', UUID());
        </sql>
    </changeSet>

    <changeSet id="cfl-20190809-09:03" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM encounter_type WHERE uuid = '6932803d-f0a3-44e5-90cd-e08d86f98d70';
            </sqlCheck>
        </preConditions>
        <comment>Added encounter type used by the CFL HIV form</comment>
        <insert tableName="encounter_type">
            <column name="name">CFL HIV Visit</column>
            <column name="description">CFL HIV visit</column>
            <column name="creator">1</column>
            <column name="date_created">2019-08-08</column>
            <column name="uuid">6932803d-f0a3-44e5-90cd-e08d86f98d70</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190812-09:00" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_tag" />
            <tableExists tableName="patientflags_tag_role" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23';
            </sqlCheck>
        </preConditions>
        <comment>Added the new patient tag and add privileges for them</comment>
        <sql>
            INSERT INTO patientflags_tag
            (name, description, creator, date_created, uuid)
            VALUES('CFL tag', 'CFL patient flag tag', 1, '2019-08-12', 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23');

            INSERT INTO patientflags_tag_role
            SELECT (SELECT tag_id FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23'), role
            FROM role;
        </sql>
    </changeSet>

    <changeSet id="cfl-20190812-09:01" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_priority" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_priority WHERE uuid = '15d23b9b-1dc1-448c-81ce-8c5d191b0fff';
            </sqlCheck>
        </preConditions>
        <comment>Added the patient flag priority</comment>
        <sql>
            INSERT INTO patientflags_priority
            (name, `style`, `rank`, creator, date_created, uuid)
            VALUES('CFL flag priority', 'border: 1px solid #51a351; color: #51a351; padding: 1px 2px; border-radius: 4px;',
            1, 1, '2019-08-12', '15d23b9b-1dc1-448c-81ce-8c5d191b0fff');
        </sql>
    </changeSet>

    <changeSet id="cfl-20190812-09:02" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = '60c36969-e85c-4e72-bcef-43e0e106a7f1';
            </sqlCheck>
        </preConditions>
        <comment>Added the patient flag (missed 3 visits) and connect with flag tag</comment>
        <sql>
            INSERT INTO patientflags_flag
            (name, criteria, message, enabled, evaluator, creator, date_created, uuid, priority_id)
            VALUES('CFL flag - missed last 3 visits', 'SELECT i.patient_id
            FROM   (SELECT st.patient_id,
            st.status,
            Count(st.status) AS count
            FROM   (SELECT
            a.patient_id,
            a.status,
            @rn := IF(@prev = a.patient_id, @rn + 1, 1) AS rn,
            @prev := a.patient_id
            FROM openmrs.appointmentscheduling_appointment a
            JOIN (SELECT @prev := NULL, @rn := 0) AS vars
            HAVING @rn &lt; 3
            ORDER BY a.patient_id, a.date_changed IS NULL DESC, a.date_changed DESC) st
            GROUP  BY st.patient_id,
            st.status) i
            WHERE  i.status = ''MISSED''
            AND count > 2;',
            'Patient missed last 3 visits', 1, 'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',
            1, '2019-08-12', '60c36969-e85c-4e72-bcef-43e0e106a7f1',
            (SELECT priority_id FROM patientflags_priority WHERE uuid = '15d23b9b-1dc1-448c-81ce-8c5d191b0fff'));

            INSERT INTO patientflags_flag_tag
            (flag_id, tag_id)
            VALUES ((SELECT flag_id FROM patientflags_flag WHERE uuid = '60c36969-e85c-4e72-bcef-43e0e106a7f1'),
            (SELECT tag_id FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23'));
        </sql>
    </changeSet>

    <changeSet id="cfl-20190812-09:04" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = 'f900fe9f-1c68-4d6d-a578-a22b9a254b70';
            </sqlCheck>
        </preConditions>
        <comment>Added the patient flag (last HIV encounter) and connect with flag tag</comment>
        <sql>
            INSERT INTO patientflags_flag
            (name, criteria, message, enabled, evaluator, creator, date_created, uuid, priority_id)
            VALUES('CFL HIV encounter', "SELECT e.patient_id, DATE_FORMAT(e.encounter_datetime, '%d.%m.%Y')
            FROM (SELECT * FROM encounter ORDER BY encounter_datetime DESC) e
            WHERE e.encounter_type IN
                (SELECT encounter_type_id FROM encounter_type WHERE uuid = '6932803d-f0a3-44e5-90cd-e08d86f98d70');",
            'Last CFL HIV encounter on ${1}', 1, 'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',
            1, '2019-08-12', 'f900fe9f-1c68-4d6d-a578-a22b9a254b70',
            (SELECT priority_id FROM patientflags_priority WHERE uuid = '15d23b9b-1dc1-448c-81ce-8c5d191b0fff'));

            INSERT INTO patientflags_flag_tag
            (flag_id, tag_id)
            VALUES ((SELECT flag_id FROM patientflags_flag WHERE uuid = 'f900fe9f-1c68-4d6d-a578-a22b9a254b70'),
            (SELECT tag_id FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23'));
        </sql>
    </changeSet>

    <changeSet id="cfl-20190826-11:50" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM person_attribute_type WHERE uuid = "58cb9e76-75a1-4f49-956f-4ff6d0e02312";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the email personAttribute.
        </comment>
        <insert tableName="person_attribute_type">
            <column name="name">EmailAttribute</column>
            <column name="description">Attribute used to store information about patient email</column>
            <column name="format">java.lang.String</column>
            <column name="searchable">0</column>
            <column name="uuid">58cb9e76-75a1-4f49-956f-4ff6d0e02312</column>
            <column name="date_created">2019-08-08</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20190827-15:50" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="relationship_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM relationship_type WHERE uuid = "acec590b-825e-45d2-876a-0028f174903d";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the caregiver relationship type.
        </comment>
        <insert tableName="relationship_type">
            <column name="a_is_to_b">Caregiver</column>
            <column name="b_is_to_a">Caretaker</column>
            <column name="preferred">0</column>
            <column name="weight">0</column>
            <column name="description">Caregiver relationship</column>
            <column name="uuid">acec590b-825e-45d2-876a-0028f174903d</column>
            <column name="date_created">2019-08-27</column>
            <column name="creator">1</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200513-09:50" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="visit_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM visit_type WHERE name = 'Follow-up';
            </sqlCheck>
        </preConditions>
        <comment>
            Introduced to fix the issue with failing `cfl-20200306-12:50` migration.
            We couldn't just remove / change failing migration because
            this migration was executed on several existing instances.
            In case of cleaning this file the `cfl-20200306-12:50` migration can be removed.
        </comment>
        <insert tableName="visit_type">
            <column name="name">Follow-up</column>
            <column name="description">Follow-up visit type.</column>
            <column name="creator">1</column>
            <column name="date_created">2020-03-06</column>
            <column name="uuid">d65fbf28-35ee-4792-bafa-bb8595806152</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200306-12:50" author="Paweł Cieszko">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="visit_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM visit_type WHERE name = 'Follow-up';
            </sqlCheck>
        </preConditions>
        <comment>
            Adding Follow-up visit type.
        </comment>
        <insert tableName="visit_type">
            <column name="name">Follow-up</column>
            <column name="description">Follow-up visit type.</column>
            <column name="creator">1</column>
            <column name="date_created">2020-03-06</column>
            <column name="uuid">7b0f5697-27e3-40c4-8bae-f4049abfb4ed</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200306-12:51" author="Paweł Cieszko">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="visit_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM visit_type WHERE name = 'Medicine refill';
            </sqlCheck>
        </preConditions>
        <comment>
            Adding Medicine refill visit type.
        </comment>
        <insert tableName="visit_type">
            <column name="name">Medicine refill</column>
            <column name="description">Medicine refill visit type.</column>
            <column name="creator">1</column>
            <column name="date_created">2020-03-06</column>
            <column name="uuid">3627f825-37f2-455b-80e4-86942a409502</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200306-12:52" author="Paweł Cieszko">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="visit_type" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM visit_type WHERE name = 'Sputum collection';
            </sqlCheck>
        </preConditions>
        <comment>
            Adding Sputum collection visit type.
        </comment>
        <insert tableName="visit_type">
            <column name="name">Sputum collection</column>
            <column name="description">Sputum collection visit type.</column>
            <column name="creator">1</column>
            <column name="date_created">2020-03-06</column>
            <column name="uuid">7e0800f0-f3bd-4f64-82e2-266644e3473a</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200318-07:50" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="relationship_type" />
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM relationship_type WHERE uuid = "acec590b-825e-45d2-876a-0028f174903d" AND b_is_to_a = "Caretaker";
            </sqlCheck>
        </preConditions>
        <comment>
            Updates the caregiver relationship type.
        </comment>
        <update tableName="relationship_type">
            <column name="a_is_to_b">Caregiver</column>
            <column name="b_is_to_a">Patient</column>
            <column name="preferred">0</column>
            <column name="weight">0</column>
            <column name="description">Relationship type used to represent the relationship between Caregiver and Patient</column>
            <column name="date_changed">2020-03-18</column>
            <column name="changed_by">1</column>
            <where>uuid = "acec590b-825e-45d2-876a-0028f174903d"</where>
        </update>
    </changeSet>

    <changeSet id="cfl-20200319-13:02" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="1">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = '60c36969-e85c-4e72-bcef-43e0e106a7f1';
            </sqlCheck>
        </preConditions>
        <comment>Updated the patient flag (missed at least 3 visits).</comment>
        <sql>
            <![CDATA[
            UPDATE openmrs.patientflags_flag
                SET name = 'CFL flag - missed at last 3 visits',
                    criteria = 'SELECT
                        i.patient_id
                        FROM
                        (
                            SELECT
                            st.patient_id,
                            st.status,
                            Count(st.status) AS missed_count
                            FROM
                            (
                            SELECT
                            *
                            FROM
                            (
                            SELECT
                            a.patient_id,
                            a.status,
                            @rn := IF(@prev = a.patient_id, @rn + 1, 1) as rn,
                            @prev := a.patient_id
                            FROM
                            (
                            SELECT
                            v.visit_id,
                            v.patient_id,
                            va.value_reference as status,
                            v.date_started as scheduled_date
                            FROM
                            openmrs.visit v
                            INNER JOIN (
                            SELECT
                            *
                            FROM
                            openmrs.visit_attribute
                            WHERE
                            attribute_type_id = (
                            SELECT
                            vat.visit_attribute_type_id
                            FROM
                            openmrs.visit_attribute_type vat
                            WHERE
                            vat.uuid = "70ca70ac-53fd-49e4-9abe-663d4785fe62"
                            )
                            AND voided = 0
                            AND value_reference <> "SCHEDULED"
                            ORDER BY
                            date_created DESC
                            ) va ON v.visit_id = va.visit_id
                            ORDER BY
                            v.patient_id DESC,
                            v.date_started DESC
                            ) a
                            JOIN (
                            SELECT
                            @prev := NULL,
                            @rn := 0
                            ) AS vars
                            ORDER BY
                            a.patient_id,
                            a.scheduled_date DESC
                            ) test
                            WHERE
                            test.rn < 4
                            ) st
                            GROUP BY
                            st.patient_id,
                            st.status
                            ) i
                        WHERE
                        i.status = "MISSED"
                        AND missed_count > 2;',
                    message = 'Missed at last 3 visits',
                    changed_by = 1,
                    date_changed = '2020-03-19 12:52:30'
            WHERE uuid = '60c36969-e85c-4e72-bcef-43e0e106a7f1';
            ]]>
        </sql>
    </changeSet>

    <changeSet id="cfl-20200319-14:02" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = 'eebf7ed0-6a86-4de7-8ab3-ab781926c191';
            </sqlCheck>
            <sqlCheck expectedResult="0">
                SELECT COUNT(name) FROM patientflags_flag WHERE name = 'Consent Pending';
            </sqlCheck>
        </preConditions>
        <comment>Added the 'Consent Pending' patient flag and connect with flag tag</comment>
        <sql>
            INSERT INTO patientflags_flag
            (name, criteria, message, enabled, evaluator, creator, date_created, uuid, priority_id)
            VALUES('Consent Pending', 'SELECT
            a.patient_id
            FROM
            patient a
            WHERE
            a.patient_id in (SELECT
            person_id
            FROM
            person_attribute
            WHERE
            person_attribute_type_id IN (SELECT pat.person_attribute_type_id FROM person_attribute_type pat WHERE pat.name = ''Person status'')
            AND voided = 0
            AND value = ''NO_CONSENT'');',
            'Consent Pending', 1, 'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',
            1, '2020-03-19', 'eebf7ed0-6a86-4de7-8ab3-ab781926c191',
            (SELECT priority_id FROM patientflags_priority WHERE uuid = '15d23b9b-1dc1-448c-81ce-8c5d191b0fff'));

            INSERT INTO patientflags_flag_tag
            (flag_id, tag_id)
            VALUES ((SELECT flag_id FROM patientflags_flag WHERE uuid = 'eebf7ed0-6a86-4de7-8ab3-ab781926c191'),
            (SELECT tag_id FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23'));
        </sql>
    </changeSet>

    <changeSet id="cfl-20200319-15:02" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="1">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = '60c36969-e85c-4e72-bcef-43e0e106a7f1';
            </sqlCheck>
        </preConditions>
        <comment>Updated the patient flag (missed least 3 visits).</comment>
        <sql>
            <![CDATA[
            UPDATE openmrs.patientflags_flag
                SET name = 'CFL flag - missed last 3 visits',
                    criteria = 'SELECT
                        i.patient_id
                        FROM
                        (
                            SELECT
                            st.patient_id,
                            st.status,
                            Count(st.status) AS missed_count
                            FROM
                            (
                            SELECT
                            *
                            FROM
                            (
                            SELECT
                            a.patient_id,
                            a.status,
                            @rn := IF(@prev = a.patient_id, @rn + 1, 1) as rn,
                            @prev := a.patient_id
                            FROM
                            (
                            SELECT
                            v.visit_id,
                            v.patient_id,
                            va.value_reference as status,
                            v.date_started as scheduled_date
                            FROM
                            openmrs.visit v
                            INNER JOIN (
                            SELECT
                            *
                            FROM
                            openmrs.visit_attribute
                            WHERE
                            attribute_type_id = (
                            SELECT
                            vat.visit_attribute_type_id
                            FROM
                            openmrs.visit_attribute_type vat
                            WHERE
                            vat.uuid = "70ca70ac-53fd-49e4-9abe-663d4785fe62"
                            )
                            AND voided = 0
                            AND value_reference <> "SCHEDULED"
                            ORDER BY
                            date_created DESC
                            ) va ON v.visit_id = va.visit_id
                            ORDER BY
                            v.patient_id DESC,
                            v.date_started DESC
                            ) a
                            JOIN (
                            SELECT
                            @prev := NULL,
                            @rn := 0
                            ) AS vars
                            ORDER BY
                            a.patient_id,
                            a.scheduled_date DESC
                            ) test
                            WHERE
                            test.rn < 4
                            ) st
                            GROUP BY
                            st.patient_id,
                            st.status
                            ) i
                        WHERE
                        i.status = "MISSED"
                        AND missed_count > 2;',
                    message = 'Missed last 3 visits',
                    changed_by = 1,
                    date_changed = '2020-03-19 12:52:30'
            WHERE uuid = '60c36969-e85c-4e72-bcef-43e0e106a7f1';
            ]]>
        </sql>
    </changeSet>

    <changeSet id="cfl-20200323-10:07" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="user_property" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(user_id) FROM user_property WHERE user_id = 1 AND property = "locationUuid";
            </sqlCheck>
        </preConditions>
        <comment>Assign the default location to the default admin user</comment>
        <insert tableName="user_property">
            <column name="user_id">1</column>
            <column name="property">locationUuid</column>
            <column name="property_value">b1a8b05e-3542-4037-bbd3-998ee9c40574</column>
        </insert>
    </changeSet>

    <changeSet id="cfl-20200401-17:53" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patient_identifier_type" />
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM patient_identifier_type WHERE uuid ="4aa897a3-0b05-4ec9-8d70-a93a336be548";
            </sqlCheck>
        </preConditions>
        <comment>
            Added the format validation for the Aadhar Number patientIdentifierType.
        </comment>
        <update tableName="patient_identifier_type">
            <column name="date_changed">2020-04-01</column>
            <column name="changed_by">1</column>
            <column name="format">[0-9]{12}$</column>
            <column name="format_description">Aadhar number should be 12 digits</column>
            <where>uuid = "4aa897a3-0b05-4ec9-8d70-a93a336be548"</where>
        </update>
    </changeSet>

    <changeSet id="cfl-20200415-12:53" author="Arkadiusz Lalo">
        <preConditions>
            <tableExists tableName="global_property"/>
        </preConditions>

        <comment>Resets cfl.findPerson.filter.strategy to the default value (the property structure and its description
            have been changed). It is in order to apply the new changes to all already existing environments. The
            migration can be removed if the liquibase refactor will be conducted (eg. replacing all changes by one
            changeSet).</comment>

        <delete tableName="global_property">
            <where>property='cfl.findPerson.filter.strategy'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-20200416-10:00" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patient_identifier_type" />
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM patient_identifier_type WHERE uuid ="4aa897a3-0b05-4ec9-8d70-a93a336be548";
            </sqlCheck>
        </preConditions>
        <comment>
            Voiding all patient identifiers which were created before adding validation constraints on that type.
            We need to do this because identifiers with the wrong format couldn't be saving as voided (by the system).
        </comment>
        <sql>
            UPDATE patient_identifier pi
            SET pi.voided=1,
            pi.voided_by=1,
            pi.date_voided='2020-04-16 10:47:27',
            pi.void_reason='Voided after changing validation constraints for those type'
            WHERE identifier_type IN (SELECT pit.patient_identifier_type_id
                FROM   patient_identifier_type pit
                WHERE
                pit.uuid = '4aa897a3-0b05-4ec9-8d70-a93a336be548');
        </sql>
    </changeSet>

    <changeSet id="cfl-20200526-15:43" author="Arkadiusz Lalo">
        <preConditions  onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM person_attribute_type WHERE name = "Telephone Number";
            </sqlCheck>
        </preConditions>

        <comment>Made changes required to search by telephone number attribute</comment>

        <update tableName="person_attribute_type">
            <column name="searchable" value="1"/>
            <where>name = "Telephone Number"</where>
        </update>
    </changeSet>

    <changeSet id="cfl-20200526-16:43" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="person_attribute_type"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM person_attribute_type WHERE name = "Person identifier";
            </sqlCheck>
        </preConditions>

        <comment>Made changes required to search by person identifier attribute</comment>

        <update tableName="person_attribute_type">
            <column name="searchable" value="1"/>
            <where>name = "Person identifier"</where>
        </update>
    </changeSet>

    <changeSet id="cfl-20200609-14:02" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = 'ff94b5da-1962-41c3-8b68-334a75c479a7';
            </sqlCheck>
            <sqlCheck expectedResult="0">
                SELECT COUNT(name) FROM patientflags_flag WHERE name = 'Incorrect pincode';
            </sqlCheck>
        </preConditions>
        <comment>Added the 'Incorrect pincode' patient flag and connect with flag tag</comment>
        <sql>
            <![CDATA[
            INSERT INTO patientflags_flag
            (name, criteria, message, enabled, evaluator, creator, date_created, uuid, priority_id)
            VALUES('Incorrect pincode',
            'SELECT
                q.patient_id
            FROM
                (
                SELECT
                    actor_id as patient_id, text_response, count(*) rn
                FROM
                    messages_actor_response mar
                WHERE
                    mar.messages_actor_response_id IN (
                    SELECT
                        m.messages_actor_response_id
                    FROM
                        (
                        SELECT
                            m.messages_actor_response_id, m.actor_id, @rn := IF(@prev = m.actor_id, @rn + 1, 1) rn, @prev := m.actor_id
                        FROM
                            messages_actor_response m
                        JOIN (
                            SELECT
                                @prev := NULL, @rn := 0 ) AS vars
                        WHERE
                            m.text_question = "PIN"
                        ORDER BY
                            m.actor_id , m.answered_time DESC) m
                    WHERE
                        m.actor_id = mar.actor_id
                        AND m.rn < 4)
                GROUP BY
                    mar.actor_id, mar.text_response) q
            WHERE
                q.rn >= 3
                AND q.text_response = "INVALID"',
            'Incorrect pincode entered last 3 times', 1, 'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',
            1, '2020-06-09', 'ff94b5da-1962-41c3-8b68-334a75c479a7',
            (SELECT priority_id FROM patientflags_priority WHERE uuid = '15d23b9b-1dc1-448c-81ce-8c5d191b0fff'));

            INSERT INTO patientflags_flag_tag
            (flag_id, tag_id)
            VALUES ((SELECT flag_id FROM patientflags_flag WHERE uuid = 'ff94b5da-1962-41c3-8b68-334a75c479a7'),
            (SELECT tag_id FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23'));
            ]]>
        </sql>
    </changeSet>

    <changeSet id="cfl-20200609-16:00" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="patientflags_flag" />
            <tableExists tableName="patientflags_flag_tag" />
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM patientflags_flag WHERE uuid = '23798bf9-aa32-11ea-9e5e-0242ac160002';
            </sqlCheck>
            <sqlCheck expectedResult="0">
                SELECT COUNT(name) FROM patientflags_flag WHERE name = 'Decreasing adherence of a patient';
            </sqlCheck>
        </preConditions>
        <comment>Added the 'Decreasing adherence of a patient' patient flag and connect with flag tag</comment>
        <sql>
            <![CDATA[
            INSERT INTO patientflags_flag
            (name, criteria, message, enabled, evaluator, creator, date_created, uuid, priority_id)
            VALUES('Decreasing adherence',
            'SELECT adhTrend.patient_id FROM (
            SELECT adhLev1.patient_id,
            adhLev1.adh - adhLev2.adh AS adhLevDiff
            FROM (
            SELECT sum(text_response = \'YES\') / sum(text_response = \'YES\' OR text_response = \'NO\') adh,
            mar.patient_id
            FROM (
            SELECT * FROM messages_actor_response mar
            WHERE source_type LIKE \'SCHEDULED_SERVICE_GROUP\') mar
            JOIN messages_scheduled_service_group mssg ON mar.source_id = mssg.messages_scheduled_service_group_id
            JOIN messages_scheduled_service mss ON mssg.messages_scheduled_service_group_id = mss.group_id
            JOIN messages_patient_template mpt ON mss.patient_template_id = mpt.messages_patient_template_id
            JOIN messages_template mt ON mpt.template_id = mt.messages_template_id
            WHERE mt.NAME = \'Adherence report daily\'
            AND mar.answered_time >= (
            SELECT date_add(now(), interval - (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.benchmarkPeriod\') DAY))
            AND mar.answered_time <= now()
            OR mt.NAME = \'Adherence report weekly\'
            AND mar.answered_time >= (
            SELECT date_add(now(), interval - (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.benchmarkPeriod\') DAY))
            AND mar.answered_time <= now()
            GROUP BY mar.patient_id) adhLev1
            LEFT JOIN (
            SELECT sum(text_response = \'YES\') / sum(text_response = \'YES\' OR text_response = \'NO\') AS adh,
            mar.patient_id
            FROM (
            SELECT * FROM messages_actor_response mar
            WHERE source_type LIKE \'SCHEDULED_SERVICE_GROUP\') mar
            JOIN messages_scheduled_service_group mssg ON mar.source_id = mssg.messages_scheduled_service_group_id
            JOIN messages_scheduled_service mss ON mssg.messages_scheduled_service_group_id = mss.group_id
            JOIN messages_patient_template mpt ON mss.patient_template_id = mpt.messages_patient_template_id
            JOIN messages_template mt ON mpt.template_id = mt.messages_template_id
            WHERE mt.NAME = \'Adherence report daily\'
            AND mar.answered_time >= (
            SELECT date_add(now(), interval - (
            SELECT 2 * (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.benchmarkPeriod\')) DAY))
            AND mar.answered_time <= (
            SELECT date_add(now(), interval - (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.benchmarkPeriod\') DAY))
            OR mt.NAME = \'Adherence report weekly\'
            AND mar.answered_time >= (
            SELECT date_add(now(), interval - (
            SELECT 2 * (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.benchmarkPeriod\')) DAY))
            AND mar.answered_time <= (
            SELECT date_add(now(), interval - (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.benchmarkPeriod\') DAY))
            GROUP BY mar.patient_id) adhLev2
            ON adhLev1.patient_id = adhLev2.patient_id) adhTrend
            WHERE adhLevDiff < -1 * (
            SELECT (
            SELECT property_value
            FROM global_property
            WHERE property = \'messages.cutOffScoreForAdherenceTrend\') / 100)',
            'Decreasing adherence of a patient',
            1,
            'org.openmrs.module.patientflags.evaluator.SQLFlagEvaluator',
            1,
            '2020-06-09',
            '23798bf9-aa32-11ea-9e5e-0242ac160002',
            (SELECT priority_id FROM patientflags_priority WHERE uuid = '15d23b9b-1dc1-448c-81ce-8c5d191b0fff'));

            INSERT INTO patientflags_flag_tag
            (flag_id, tag_id)
            VALUES ((SELECT flag_id FROM patientflags_flag WHERE uuid = '23798bf9-aa32-11ea-9e5e-0242ac160002'),
            (SELECT tag_id FROM patientflags_tag WHERE uuid = 'ef1a1b2d-c7a5-44d7-a518-ef78087abb23'));
            ]]>
        </sql>
    </changeSet>

    <changeSet id="cfl-20200624-13:00" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="relationship_type"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM relationship_type WHERE uuid = 'acec590b-825e-45d2-876a-0028f174903d';
            </sqlCheck>
        </preConditions>

        <comment>Retired all unnecessary relationship types</comment>

        <update tableName="relationship_type">
            <column name="retired" value="1"/>
            <where>uuid != 'acec590b-825e-45d2-876a-0028f174903d'</where>
        </update>
    </changeSet>

    <changeSet id="cfl-20200708-13:00" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="cfl_callflows"/>
            <sqlCheck expectedResult="0">SELECT COUNT(*) FROM cfl_callflows</sqlCheck>
        </preConditions>
        <comment>
            Inserts the Call Flows designs into the database.
        </comment>
        <sqlFile encoding="UTF-8"
                 path="mysql/callflows.sql"
                 splitStatements="false"
                 stripComments="false"/>
    </changeSet>

    <changeSet id="cfl-20200708-13:01" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT COUNT(*) FROM openmrs.user_role
                WHERE role='Privilege Level: Full' AND user_id=1</sqlCheck>
        </preConditions>
        <comment>
            Assign the 'Privilege Level: Full' role to the admin user (id = 1).
        </comment>
        <sql>
            INSERT INTO openmrs.user_role
            (user_id, `role`)
            VALUES(1, 'Privilege Level: Full');
        </sql>
    </changeSet>

    <changeSet id="cfl-2020-07-09-23:00" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM global_property WHERE property='coreapps.conditionListClasses'
            </sqlCheck>
        </preConditions>

        <comment>
            Removed coreapps.conditionListClasses property in order to update default value via activator.
            The migration can be removed if the liquibase refactor will be conducted
            (eg. replacing all changes by one changeSet).
        </comment>

        <delete tableName="global_property">
            <where>property='coreapps.conditionListClasses'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-2020-07-14-16:00" author="Arkadiusz Lalo">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM global_property WHERE property='emrapi.useLegacyDiagnosisService'
            </sqlCheck>
        </preConditions>

        <comment>
            Updates emrapi.useLegacyDiagnosisService property in order to change the default value.
        </comment>

        <update tableName="global_property">
            <column name="property_value">true</column>
            <where>property='emrapi.useLegacyDiagnosisService'</where>
        </update>
    </changeSet>

    <changeSet id="cfl-20201123-17:45" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM global_property WHERE property='cfl.sendSmsOnPatientRegistration'
            </sqlCheck>
        </preConditions>

        <comment>Removed property because of moving this property to other place</comment>

        <delete tableName="global_property">
            <where>property='cfl.sendSmsOnPatientRegistration'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-20201123-17:50" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM global_property WHERE property='cfl.performCallOnPatientRegistration'
            </sqlCheck>
        </preConditions>

        <comment>Removed property because of moving this property to other place</comment>

        <delete tableName="global_property">
            <where>property='cfl.performCallOnPatientRegistration'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-20201123-17:55" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM global_property WHERE property='cfl.shouldSendReminderViaSms'
            </sqlCheck>
        </preConditions>

        <comment>Removed property because of moving this property to other place</comment>

        <delete tableName="global_property">
            <where>property='cfl.shouldSendReminderViaSms'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-20201123-18:00" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="global_property"/>
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM global_property WHERE property='cfl.shouldSendReminderViaCall'
            </sqlCheck>
        </preConditions>

        <comment>Removed property because of moving this property to other place</comment>

        <delete tableName="global_property">
            <where>property='cfl.shouldSendReminderViaCall'</where>
        </delete>
    </changeSet>

    <changeSet id="cfl-20210122-17:00" author="Dawid Ruchniewicz">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(uuid) FROM encounter_type WHERE uuid = '43c3630f-abfe-4fe1-8c92-b73b65199a3d';
            </sqlCheck>
        </preConditions>
        <comment>Added encounter type used by the CFL Symptoms form</comment>
        <insert tableName="encounter_type">
            <column name="name">Symptoms</column>
            <column name="creator">1</column>
            <column name="date_created">2021-01-22</column>
            <column name="uuid">43c3630f-abfe-4fe1-8c92-b73b65199a3d</column>
        </insert>
    </changeSet>
</databaseChangeLog>
